# Add tag to Main and create Release in GitHub.com
name: tag-release
run-name: Tag and Release ðŸš€

on:
  workflow_call:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
# permissions:
#  contents: read

jobs:
  # if branch = main
  semver-tag:
    name: SemVer Tag
    timeout-minutes: 10
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
    steps:

      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get Next Tag Version
        id: next-version
        uses: paulhatch/semantic-version@v5.0.3
        # https://github.com/PaulHatch/semantic-version
        with:
          tag_prefix: 'v'
          version_format: '${major}.${minor}.${patch}'

      - name: Display SemVer
        run: echo "${{ steps.next-version.outputs.version_tag }}"

      - name: Get NPM Package Version
        id: package-version
        uses: martinbeentjes/npm-get-version-action@v1.2.3
        # https://github.com/martinbeentjes/npm-get-version-action

      - name: Versions Do Not Match
        id: version-check
        if: ${{ steps.next-version.outputs.version_tag != format('{0}{1}', 'v', steps.package-version.outputs.current-version) }}
        run: |
          echo "SemVer Tag: ${{ steps.next-version.outputs.version_tag }}"
          echo "NPM Package Version: ${{ steps.package-version.outputs.current-version }}"
          exit 1

      - name: Create Card in Project
        if: ${{ failure() && steps.version-check.conclusion == 'failure' }}
        run: gh issue create --title "Package ${{ steps.package-version.outputs.current-version }} vs SemVer ${{ steps.next-version.outputs.version_tag }}" --body "Please update Package.JSON on next feature" --label "error-tagging"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download CI Build Artifact
        uses: actions/github-script@v6
        with:
          script: |
            let allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
               owner: context.repo.owner,
               repo: context.repo.repo,
               run_id: context.payload.workflow_run.id,
            });
            let matchArtifact = allArtifacts.data.artifacts.filter((artifact) => {
              return artifact.name == "stg-build"
            })[0];
            let download = await github.rest.actions.downloadArtifact({
               owner: context.repo.owner,
               repo: context.repo.repo,
               artifact_id: matchArtifact.id,
               archive_format: 'zip',
            });
            let fs = require('fs');
            fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/deploy.zip`, Buffer.from(download.data));
   
      - name: Tag and Release
        run: gh release create ${{ steps.next-version.outputs.version_tag }} ./deploy.zip --generate-notes --latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
 