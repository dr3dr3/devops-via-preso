# Add tag to Main and create Release in GitHub.com
name: tag-release
run-name: Tag and Release üöÄ

on:
  workflow_call:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
# permissions:
#  contents: read

jobs:
  # if branch = main
  semver-tag:
    name: SemVer Tag
    timeout-minutes: 10
    runs-on: ubuntu-latest
    permissions:
      repository-projects: write
    steps:

      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get Next Tag Version
        id: next-version
        uses: paulhatch/semantic-version@v5.0.3
        # https://github.com/PaulHatch/semantic-version
        with:
          tag_prefix: 'v'
          version_format: '${major}.${minor}.${patch}'

      - name: Display SemVer
        run: echo "${{ steps.next-version.outputs.version_tag }}"

      - name: Get NPM Package Version
        id: package-version
        uses: martinbeentjes/npm-get-version-action@v1.2.3
        # https://github.com/martinbeentjes/npm-get-version-action

      - name: Versions Do Not Match
        id: version-check
        if: ${{ steps.next-version.outputs.version_tag != format('{0}{1}', 'v', steps.package-version.outputs.current-version) }}
        run: |
          echo "SemVer Tag: ${{ steps.next-version.outputs.version_tag }}"
          echo "NPM Package Version: ${{ steps.package-version.outputs.current-version }}"
          exit 1

      - name: Create Card in Project
        if: ${{ failure() && steps.version-check.conclusion == 'failure' }}
        run: gh issue create --project "@dr3dr3's DevOps Demo" --title "Package ${{ steps.package-version.outputs.current-version }} vs SemVer ${{ steps.next-version.outputs.version_tag }}" --body "Please update Package.JSON on next feature" --label "error-tagging"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag and Release
        run: gh release create ${{ steps.next-version.outputs.version_tag }} --draft --generate-notes --latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
 